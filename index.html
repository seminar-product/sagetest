<!DOCTYPE html>
<html>
<head>
    <title>Seminar Sage Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Mulish&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #voiceflow-container {
            border: none; /* Remove iframe border if desired */
            width: 100vw;  /* Full viewport width */
            height: 100vh; /* Full viewport height */
            position: fixed;
            top: 0;
            left: 0;
            font-family: 'Mulish', sans-serif !important;
        }
    </style>
</head>
<body>
    <div id="voiceflow-container"></div>
    <script type="text/javascript">
  (function(d, t) {
    var v = d.createElement(t),
        s = d.getElementsByTagName(t)[0];

    v.onload = function() {
      window.voiceflow.chat.load({
        verify: { projectID: '683752618749c0adc82ba60b' },
        url: 'https://general-runtime.voiceflow.com',
        versionID: 'production',
        voice: {
          url: "https://runtime-api.voiceflow.com"
        },
        assistant: {
          extensions: [FileUploadExtension]
        },
        render: {
          mode: 'embedded',
          target: document.getElementById('voiceflow-container') // âœ… attach to div
        }
      });
    };

    v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
    v.type = "text/javascript";
    s.parentNode.insertBefore(v, s);

    // ðŸ“¦ Define the FileUploadExtension
    const FileUploadExtension = {
      name: 'FileUpload',
      type: 'response',
      match: ({ trace }) =>
        trace.type === 'ext_csvFileUpload' ||
        trace.payload?.name === 'ext_csvFileUpload',

      render: ({ trace, element }) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = trace.payload.accepted || '*/*';
        input.multiple = true;

        input.onchange = () => {
          const files = Array.from(input.files || []);
          const MAX_SIZE = 3 * 1024 * 1024; // 3 MB

          const validFiles = files.filter(file => {
            if (file.size > MAX_SIZE) {
              alert(`File "${file.name}" is too large. Max size is 3MB.`);
              return false;
            }
            return true;
          });

          if (validFiles.length === 0) return;

          const fileReadPromises = validFiles.map(file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                try {
                  const base64 = reader.result.split(',')[1];
                  resolve({
                    fileName: file.name,
                    fileType: file.type,
                    fileData: atob(base64)
                  });
                } catch (err) {
                  reject(err);
                }
              };
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
          });

          Promise.all(fileReadPromises)
            .then(filePayloads => {
              window.voiceflow.chat.interact({
                type: 'complete',
                payload: { files: filePayloads }
              });
            })
            .catch(err => {
              alert("Error reading one or more files.");
              console.error(err);
            });
        };

        element.appendChild(input);
      }
    };
  })(document, 'script');
</script>
</body>
</html>
