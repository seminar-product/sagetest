<!DOCTYPE html>
<html>
<head>
    <title>Seminar Sage Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Mulish&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #voiceflow-container {
            border: none;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            font-family: 'Mulish', sans-serif !important;
        }
    </style>
</head>
<body>
    <div id="voiceflow-container"></div>

    <!-- ðŸ†• DOCX â†’ TEXT converter -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

    <script type="text/javascript">
  (function(d, t) {
    var v = d.createElement(t),
        s = d.getElementsByTagName(t)[0];

    v.onload = function() {
      window.voiceflow.chat.load({
        verify: { projectID: '683752618749c0adc82ba60b' },
        url: 'https://general-runtime.voiceflow.com',
        versionID: 'production',
        voice: {
          url: "https://runtime-api.voiceflow.com"
        },
        assistant: {
          extensions: [FileUploadExtension]
        },
        render: {
          mode: 'embedded',
          target: document.getElementById('voiceflow-container')
        }
      });
    };

    v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
    v.type = "text/javascript";
    s.parentNode.insertBefore(v, s);

    // ðŸ“¦ Define the FileUploadExtension
    const FileUploadExtension = {
      name: 'FileUpload',
      type: 'response',
      match: ({ trace }) =>
        trace.type === 'ext_csvFileUpload' ||
        trace.payload?.name === 'ext_csvFileUpload',
    
      render: ({ trace, element }) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = trace.payload.accepted || '*/*';
        input.multiple = true;
    
        input.onchange = () => {
          const files = Array.from(input.files || []);
          const MAX_SIZE = 3 * 1024 * 1024; // 3 MB
    
          const validFiles = files.filter(file => {
            if (file.size > MAX_SIZE) {
              alert(`File "${file.name}" is too large. Max size is 3MB.`);
              return false;
            }
            return true;
          });
    
          if (validFiles.length === 0) return;
    
          const fileReadPromises = validFiles.map(file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
    
              reader.onload = () => {
                try {
                  const base64 = reader.result.split(',')[1];

                  // ----------------------------------------------------
                  // UPDATED SECTION â€” DOCX â†’ TEXT support
                  // ----------------------------------------------------

                  let fileData;

                  const binaryTypes = [
                    "application/vnd.openxmlformats-officedocument.wordprocessingml.document", // DOCX
                    "application/pdf",
                    "application/zip",
                    "application/vnd.ms-excel",
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "image/png",
                    "image/jpeg",
                    "image/gif",
                  ];

                  if (
                    file.type.startsWith("text/") ||
                    file.name.endsWith(".csv") ||
                    file.name.endsWith(".txt")
                  ) {
                    fileData = atob(base64);
                    resolve({
                      fileName: file.name,
                      fileType: file.type,
                      fileData
                    });
                  }

                  else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {

                    // Convert Base64 â†’ ArrayBuffer for Mammoth
                    const arrayBuffer = Uint8Array.from(
                      atob(base64),
                      c => c.charCodeAt(0)
                    ).buffer;

                    // Convert DOCX â†’ TEXT
                    mammoth.extractRawText({ arrayBuffer })
                      .then(result => {
                        resolve({
                          fileName: file.name,
                          fileType: "text/plain",
                          fileData: result.value // clean extracted text
                        });
                      })
                      .catch(err => {
                        console.error("DOCX conversion failed:", err);
                        resolve({
                          fileName: file.name,
                          fileType: "text/plain",
                          fileData: "[Could not extract text]"
                        });
                      });

                  }

                  else {
                    // Keep other binary types as base64
                    fileData = base64;
                    resolve({
                      fileName: file.name,
                      fileType: file.type,
                      fileData
                    });
                  }

                  // ----------------------------------------------------

                } catch (err) {
                  reject(err);
                }
              };
    
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
          });
    
          Promise.all(fileReadPromises)
            .then(filePayloads => {
              window.voiceflow.chat.interact({
                type: 'complete',
                payload: { files: filePayloads }
              });
            })
            .catch(err => {
              alert("Error reading one or more files.");
              console.error(err);
            });
        };
    
        element.appendChild(input);
      }
    };
</script>
</body>
</html>
